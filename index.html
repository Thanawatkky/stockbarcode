<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scan Barcode</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <style>
        #scanner {
            width: 100%;
            height: auto;
        }
        .mirrored {
            transform: scaleX(-1);
        }
    </style>
</head>
<body>
    <h1>Scan Barcode</h1>
    <video id="scanner" width="400" height="300" autoplay></video>
    <p>Scanned Code: <span id="result"></span></p>
    <button id="flip-btn">Flip Camera</button>

    <script>
        let facingMode = "environment"; // กำหนดค่าเริ่มต้นเป็นกล้องหลัง
        let currentStream = null;

        // ฟังก์ชันเริ่มต้นกล้อง
        async function startCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop()); // ปิดกล้องเก่าก่อนเปิดใหม่
            }

            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: facingMode } // ใช้ค่าของ facingMode ที่กำหนด
                });
                const video = document.getElementById("scanner");
                video.srcObject = stream;
                currentStream = stream;

                // ถ้าใช้กล้องหน้า -> เพิ่มคลาส mirrored
                if (facingMode === "user") {
                    video.classList.add("mirrored");
                } else {
                    video.classList.remove("mirrored");
                }
            } catch (err) {
                console.error("Error accessing camera: ", err);
                alert("ไม่สามารถเปิดกล้องได้.");
            }
        }

        // สลับกล้อง
        document.getElementById("flip-btn").addEventListener("click", () => {
            facingMode = facingMode === "environment" ? "user" : "environment"; // สลับกล้อง
            startCamera();
        });

        startCamera(); // เรียกฟังก์ชันเริ่มต้นกล้องตอนโหลดหน้าเว็บ

        // รอให้ video element โหลดเสร็จ แล้วเริ่มการสแกน
        document.getElementById("scanner").onloadeddata = function() {
            // เริ่ม QuaggaJS เพื่อสแกนบาร์โค้ด
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector("#scanner"),
                    constraints: {
                        width: 1280,   // เพิ่มความละเอียดของกล้อง
                        height: 720,   // เพิ่มความละเอียดของกล้อง
                        facingMode: facingMode
                    },
                    willReadFrequently: true
                },
                decoder: {
                    readers: [
                        "ean_reader",       // EAN-13
                        "ean_8_reader",     // EAN-8
                        "upc_reader",       // UPC
                        "code_128_reader",  // Code 128
                        "qr_reader"         // QR Code
                    ]
                },
                locate: true,
                multiple: false,  // ไม่ต้องการหลายการสแกนพร้อมกัน
                inputStream: {
                    size: 800
                }
            }, function(err) {
                if (err) {
                    console.error("Quagga init failed:", err);
                    return;
                }
                console.log("Quagga initialized successfully!");
                Quagga.start();
            });
        };

        // เมื่อมีการสแกนบาร์โค้ด
        Quagga.onDetected(function(data) {
            console.log("Barcode detected:", data.codeResult.code);
            document.getElementById("result").innerText = "Scanned Code: " + data.codeResult.code;
            Quagga.stop();
        });
    </script>
</body>
</html>
